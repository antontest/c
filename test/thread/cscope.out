cscope 15 $HOME/working/program/c/thread -q 0000000076 0000009049
	@bak/thread.c

1 
	~<°dio.h
>

2 
	~<uni°d.h
>

3 
	~<±hªad.h
>

4 
	~<£m≠h‹e.h
>

5 
	~<°dboﬁ.h
>

6 
	~<sys/î∫o.h
>

7 
	~<sys/waô.h
>

8 
	~<sys/£À˘.h
>

9 
	~<gë›t.h
>

10 
	~<time.h
>

16 * (*
	t±hªad_ru¡öe
)(*);

21 
	s±hªad_w‹kî
 {

22 
±hªad_ru¡öe
 
	mru¡öe
;

23 *
	m¨g
;

24 } 
	t±hªad_w‹kî_t
;

26 
	sthªad_im∂
 {

27 
	ma˘ive
;

28 
	mrun
;

29 
	mdñëe
;

30 
	md⁄e
;

31 
±hªad_t
 
	mpid
;

32 
±hªad_w‹kî_t
 
	mw‹kî
;

33 
±hªad_muãx_t
 
	mlock
;

34 
±hªad_c⁄d_t
 
	mªady
;

35 } 
	tthªad_t
;

40 
±hªad_°¨t
(
thªad_t
 *
±
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
, 
run
);

41 
±hªad_exec
(
thªad_t
 *
±
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
);

42 
±hªad_run
(
thªad_t
 *
±
);

43 
±hªad_waô_ovî
(
thªad_t
 *
±
);

44 
±hªad_dñëe
(
thªad_t
 *
±
);

45 
±hªad_lock
(
thªad_t
 *
±
);

46 
±hªad_åylock
(
thªad_t
 *
±
);

47 
±hªad_u∆ock
(
thªad_t
 *
±
);

49 * 
	$echo
(*
¨g
)

54 
	`¥ötf
("hñlo: %s\n", (*)
¨g
);

55 
	`¶ìp
(1);

56 
	`±hªad_ã°ˇn˚l
();

60 
	`¥ötf
("test cancel failed\n");

61  
NULL
;

62 
	}
}

64 *
	$ã°
(*
¨g
)

66 
	`¥ötf
("ã° %s\n", (*)
¨g
);

68  
NULL
;

69 
	}
}

74 
	$maö
(
agrc
, *
agrv
[])

76 
π
 = 0;

77 
thªad_t
 
pô
;

79 
	`±hªad_°¨t
(&
pô
, 
echo
, "1", 1);

80 
	`¶ìp
(2);

81 
	`±hªad_ˇn˚l
(
pô
.
pid
);

83 
	`¶ìp
(2);

86 
	`±hªad_waô_ovî
(&
pô
);

88  
π
;

89 
	}
}

98 *
	$thªad_ru¡öe
(*
¨g
)

100 
thªad_t
 *
im∂
 = (thªad_à*)
¨g
;

101 
±hªad_w‹kî_t
 *
w‹kî
 = &
im∂
->worker;

103 
im∂
->
a˘ive
)

105 
w‹kî
 = &
im∂
->worker;

106 i‡(!
im∂
->
run
) ;

107 i‡(
im∂
->
dñëe
) ;

109 i‡(
w‹kî
->
ru¡öe
 !
NULL
)

111 
w‹kî
->
	`ru¡öe
(w‹kî->
¨g
);

113 
w‹kî
->
ru¡öe
 = 
NULL
;

114 
w‹kî
->
¨g
 = 
NULL
;

115 
im∂
->
d⁄e
 = 1;

119 
im∂
->
a˘ive
 = 0;

120 
im∂
->
dñëe
 = 1;

121 
im∂
->
d⁄e
 = 1;

122 
im∂
->
run
 = 0;

124 
	`±hªad_muãx_de°roy
(&
im∂
->
lock
);

125 
	`±hªad_c⁄d_de°roy
(&
im∂
->
ªady
);

127  
NULL
;

128 
	}
}

139 
	$±hªad_°¨t
(
thªad_t
 *
im∂
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
, 
run
)

141 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
)  -1;

143 
im∂
->
w‹kî
.
ru¡öe
 =Ñuntine;

144 
im∂
->
w‹kî
.
¨g
 =árg;

146 
im∂
->
run
 =Ñun;

147 
im∂
->
d⁄e
 = 0;

148 
im∂
->
dñëe
 = 0;

149 
im∂
->
a˘ive
 = 1;

151 
	`±hªad_muãx_öô
(&
im∂
->
lock
, 
NULL
);

152 
	`±hªad_c⁄d_öô
(&
im∂
->
ªady
, 
NULL
);

154  
	`±hªad_¸óã
(&
im∂
->
pid
, 
NULL
, 
thªad_ru¡öe
, impl);

155 
	}
}

162 
	$±hªad_run
(
thªad_t
 *
im∂
)

164 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
) ;

166 
im∂
->
run
 = 1;

169 
	}
}

178 
	$±hªad_exec
(
thªad_t
 *
im∂
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
)

180 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
) ;

182 
im∂
->
run
 = 0;

183 
im∂
->
w‹kî
.
ru¡öe
 =Ñuntine;

184 
im∂
->
w‹kî
.
¨g
 =árg;

186 
im∂
->
run
 = 1;

187 
im∂
->
d⁄e
 = 0;

190 
	}
}

199 
	$±hªad_lock
(
thªad_t
 *
im∂
)

201 i‡(
im∂
 =
NULL
 || im∂->
a˘ive
)  -1;

203  
	`±hªad_muãx_lock
(&
im∂
->
lock
);

204 
	}
}

213 
	$±hªad_åylock
(
thªad_t
 *
im∂
)

215 i‡(
im∂
 =
NULL
 && !im∂->
a˘ive
)  -1;

217  
	`±hªad_muãx_åylock
(&
im∂
->
lock
);

218 
	}
}

227 
	$±hªad_u∆ock
(
thªad_t
 *
im∂
)

229 i‡(
im∂
 =
NULL
 && !im∂->
a˘ive
)  -1;

231  
	`±hªad_muãx_u∆ock
(&
im∂
->
lock
);

232 
	}
}

241 
	$±hªad_dñëe
(
thªad_t
 *
im∂
)

243 
waô_tm
 = 10 * 100;

244 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
)  -1;

246 i‡(
im∂
->
run
)

248 
waô_tm
-- > 0)

250 i‡(
im∂
->
d⁄e
) ;

251 
	`u¶ìp
(10);

255 
im∂
->
dñëe
 = 1;

256 
	`¶ìp
(1);

258 i‡(!
im∂
->
d⁄e
)

260 
	`±hªad_ˇn˚l
(
im∂
->
pid
);

261 
	`±hªad_muãx_de°roy
(&
im∂
->
lock
);

262 
	`±hªad_c⁄d_de°roy
(&
im∂
->
ªady
);

266 
	}
}

273 
	$±hªad_waô_ovî
(
thªad_t
 *
im∂
)

275 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
) ;

277 
	`±hªad_joö
(
im∂
->
pid
, 
NULL
);

280 
	}
}

282 
	$±hªad_waô_d⁄e
(
thªad_t
 *
im∂
)

284 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
) ;

287 
	}
}

	@bak/thread.h

1 #i‚de‡
__THREAD_H__


2 
	#__THREAD_H__


	)

3 
	~<°dio.h
>

4 
	~<uni°d.h
>

5 
	~<±hªad.h
>

6 
	~<£m≠h‹e.h
>

7 
	~<°dboﬁ.h
>

8 
	~<sys/î∫o.h
>

9 
	~<sys/waô.h
>

10 
	~<sys/£À˘.h
>

11 
	~<gë›t.h
>

12 
	~<time.h
>

18 * (*
	t±hªad_ru¡öe
)(*);

20 
	s±hªad_w‹kî


22 
±hªad_ru¡öe
 
	mru¡öe
;

23 *
	m¨g
;

24 } 
	t±hªad_w‹kî_t
;

26 
	sthªad_im∂


28 
	ma˘ive
;

29 
	mrun
;

30 
	mdñëe
;

31 
	md⁄e
;

32 
±hªad_t
 
	mpid
;

33 
±hªad_w‹kî_t
 
	mw‹kî
;

34 
±hªad_muãx_t
 
	mlock
;

35 
±hªad_c⁄d_t
 
	mªady
;

36 } 
	tthªad_t
;

47 
±hªad_°¨t
(
thªad_t
 *
im∂
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
, 
run
);

56 
±hªad_exec
(
thªad_t
 *
im∂
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
);

63 
±hªad_run
(
thªad_t
 *
im∂
);

72 
±hªad_lock
(
thªad_t
 *
im∂
);

81 
±hªad_åylock
(
thªad_t
 *
im∂
);

90 
±hªad_u∆ock
(
thªad_t
 *
im∂
);

99 
±hªad_dñëe
(
thªad_t
 *
im∂
);

	@thread.c

1 
	~<thªad.h
>

3 * 
	$¥öt
(*
¨g
)

5 
	`¥ötf
("¥öt: %s\n", (*)
¨g
);

6  
NULL
;

7 
	}
}

9 
	$maö
(
agrc
, *
agrv
[])

11 
thªad_t
 
t
 = {0};

12 
	`±hªad_°¨t
(&
t
, 
¥öt
, "1", 1, 1);

14 
	`±hªad_exec
(&
t
, 
¥öt
, "2");

16 
	`±hªad_dñëe
(&
t
);

17 
	`±hªad_time_waô_ovî
(&
t
, 2000);

20 
	}
}

29 *
	$thªad_ru¡öe
(*
¨g
)

31 
thªad_t
 *
im∂
 = (thªad_à*)
¨g
;

32 
±hªad_w‹kî_t
 *
w‹kî
 = &
im∂
->worker;

34 
im∂
->
a˘ive
)

36 i‡(!
im∂
->
run
) ;

38 i‡(
w‹kî
->
ru¡öe
 !
NULL
 && 
im∂
->
run
)

40 
w‹kî
->
	`ru¡öe
(w‹kî->
¨g
);

42 
w‹kî
->
ru¡öe
 = 
NULL
;

43 
w‹kî
->
¨g
 = 
NULL
;

44 
im∂
->
d⁄e
 = 1;

47 i‡(!
im∂
->
kìp
) ;

48 i‡(
im∂
->
dñëe
) ;

51 
	`¥ötf
("pthread over\n");

52 
im∂
->
a˘ive
 = 0;

53 
im∂
->
dñëe
 = 1;

54 
im∂
->
d⁄e
 = 1;

55 
im∂
->
run
 = 0;

57 
	`±hªad_muãx_de°roy
(&
im∂
->
lock
);

58 
	`±hªad_c⁄d_de°roy
(&
im∂
->
ªady
);

60  
NULL
;

61 
	}
}

72 
±hªad_°¨t
(
thªad_t
 *
im∂
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
,\

73 
run
, 
kìp
)

75 i‡(
	gim∂
 =
NULL
 || 
im∂
->
a˘ive
)  -1;

77 
	gim∂
->
	gw‹kî
.
	gru¡öe
 = 
ru¡öe
;

78 
	gim∂
->
	gw‹kî
.
	g¨g
 = 
¨g
;

80 
	gim∂
->
	grun
 = 
run
;

81 
	gim∂
->
	gkìp
 = 
kìp
;

82 
	gim∂
->
	gd⁄e
 = 0;

83 
	gim∂
->
	gdñëe
 = 0;

84 
	gim∂
->
	ga˘ive
 = 1;

86 
±hªad_muãx_öô
(&
im∂
->
lock
, 
NULL
);

87 
±hªad_c⁄d_öô
(&
im∂
->
ªady
, 
NULL
);

89  
±hªad_¸óã
(&
im∂
->
pid
, 
NULL
, 
thªad_ru¡öe
, impl);

97 
	$±hªad_run
(
thªad_t
 *
im∂
)

99 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
) ;

101 
im∂
->
run
 = 1;

102 
im∂
->
d⁄e
 = 0;

105 
	}
}

114 
	$±hªad_exec
(
thªad_t
 *
im∂
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
)

116 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
 || !im∂->
kìp
) ;

118 !
im∂
->
d⁄e
Ë
	`u¶ìp
(10);

119 
im∂
->
run
 = 0;

120 
im∂
->
w‹kî
.
ru¡öe
 =Ñuntine;

121 
im∂
->
w‹kî
.
¨g
 =árg;

123 
im∂
->
run
 = 1;

124 
im∂
->
d⁄e
 = 0;

127 
	}
}

136 
	$±hªad_lock
(
thªad_t
 *
im∂
)

138 i‡(
im∂
 =
NULL
 || im∂->
a˘ive
)  -1;

140  
	`±hªad_muãx_lock
(&
im∂
->
lock
);

141 
	}
}

150 
	$±hªad_åylock
(
thªad_t
 *
im∂
)

152 i‡(
im∂
 =
NULL
 && !im∂->
a˘ive
)  -1;

154  
	`±hªad_muãx_åylock
(&
im∂
->
lock
);

155 
	}
}

164 
	$±hªad_u∆ock
(
thªad_t
 *
im∂
)

166 i‡(
im∂
 =
NULL
 && !im∂->
a˘ive
)  -1;

168  
	`±hªad_muãx_u∆ock
(&
im∂
->
lock
);

169 
	}
}

178 
	$±hªad_dñëe
(
thªad_t
 *
im∂
)

180 
waô_tm
 = 10 * 100;

181 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
)  -1;

184 i‡(
im∂
->
run
)

186 
waô_tm
-- > 0)

188 i‡(
im∂
->
d⁄e
) ;

189 
	`u¶ìp
(10);

194 
im∂
->
dñëe
 = 1;

197 i‡(
im∂
->
run
)

199 
waô_tm
-- > 0)

201 i‡(
im∂
->
d⁄e
) ;

202 
	`u¶ìp
(10);

207 i‡(!
im∂
->
d⁄e
)

209 
	`±hªad_ˇn˚l
(
im∂
->
pid
);

210 
	`±hªad_muãx_de°roy
(&
im∂
->
lock
);

211 
	`±hªad_c⁄d_de°roy
(&
im∂
->
ªady
);

215 
	}
}

222 
	$±hªad_waô_ovî
(
thªad_t
 *
im∂
)

224 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
) ;

226 
	`±hªad_joö
(
im∂
->
pid
, 
NULL
);

229 
	}
}

236 
	$±hªad_time_waô_ovî
(
thªad_t
 *
im∂
, 
tm_ms
)

238 
timevÆ
 
tv
 = {0};

239 
timî_accuøcy
 = 100;

240 i‡(
im∂
 =
NULL
 || !im∂->
a˘ive
) ;

244 
tv
.
tv_£c
 = 0;

245 
tv
.
tv_u£c
 = 1000 * 
timî_accuøcy
;

247 
	`£À˘
(0, 
NULL
, NULL, NULL, &
tv
);

248 i‡(!
im∂
->
run
)

253 
tm_ms
 -
timî_accuøcy
;

254 i‡(
tm_ms
 <= 0)

256 i‡(
im∂
->
run
Ë
	`±hªad_ˇn˚l
(im∂->
pid
);

262 
	}
}

	@thread.h

1 #i‚de‡
__THREAD_H__


2 
	#__THREAD_H__


	)

3 
	~<°dio.h
>

4 
	~<uni°d.h
>

5 
	~<±hªad.h
>

6 
	~<sys/£À˘.h
>

12 * (*
	t±hªad_ru¡öe
)(*);

14 
	s±hªad_w‹kî


16 
±hªad_ru¡öe
 
	mru¡öe
;

17 *
	m¨g
;

18 } 
	t±hªad_w‹kî_t
;

20 
	sthªad_im∂


22 
	ma˘ive
;

23 
	mkìp
;

24 
	mrun
;

25 
	mdñëe
;

26 
	md⁄e
;

27 
±hªad_t
 
	mpid
;

28 
±hªad_w‹kî_t
 
	mw‹kî
;

29 
±hªad_muãx_t
 
	mlock
;

30 
±hªad_c⁄d_t
 
	mªady
;

31 } 
	tthªad_t
;

42 
±hªad_°¨t
(
thªad_t
 *
im∂
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
, 
run
, 
kìp
);

51 
±hªad_exec
(
thªad_t
 *
im∂
, 
±hªad_ru¡öe
 
ru¡öe
, *
¨g
);

58 
±hªad_run
(
thªad_t
 *
im∂
);

67 
±hªad_lock
(
thªad_t
 *
im∂
);

76 
±hªad_åylock
(
thªad_t
 *
im∂
);

85 
±hªad_u∆ock
(
thªad_t
 *
im∂
);

94 
±hªad_dñëe
(
thªad_t
 *
im∂
);

101 
±hªad_waô_ovî
(
thªad_t
 *
im∂
);

108 
±hªad_time_waô_ovî
(
thªad_t
 *
im∂
, 
tm_ms
);

	@
1
.
0
4
44
bak/thread.c
bak/thread.h
thread.c
thread.h
