cscope 15 $HOME/working/program/lib/proc -q 0000000115 0000008432
	@macro.h

5 #iâdeà
maüo_to_¡r


6 
	#maüo_to_¡r
(
x
è#x

	)

9 #iâdeà
maüo_ÿt


10 
	#maüo_ÿt
(
a
, 
b
èa##
	)
b

13 #iâdeà
func_Çme


14 
	#func_Çme
 
__func__


	)

17 #iâdeà
lše_num


18 
	#lše_num
 
__LINE__


	)

21 #iâdeà
debug_”rÜ


22 
	#debug_”rÜ
(...) \

24 
	`årštf
(
¡d”r
, "\033[1;35m[ Function %s ] [†ine %d ] \033[0m", \

25 
func_Çme
, 
lše_num
); \

26 
	`årštf
(
¡d”r
, ##
__VA_ARGS__
); \

27 
	`årštf
(
¡d”r
, "\n"); \

28 } 0);

	)

31 #iâdeà
debug_šfo


32 
	#debug_šfo
(...) \

34 
	`årštf
(
¡dout
, "\033[1;35m"); \

35 
	`årštf
(
¡dout
, ##
__VA_ARGS__
); \

36 
	`årštf
(
¡dout
, "\n\033[0;0m"); \

37 } 0);

	)

40 #iâdeà
off£t_of


41 
	#off£t_of
(
ty³
, 
memb”
è(()&((Ñy³ *)0)->memb”))

	)

44 #iâdeà
cÚš”_of


45 
	#cÚš”_of
(
±r
, 
ty³
, 
memb”
) ({\

46 cÚ¡ 
	`ty³of
(((
ty³
 *)0)->
memb”
è*
_m±r
 = 
±r
; \

47 (
ty³
 *)((*)
_m±r
 - 
	`off£t_of
Ñy³, 
memb”
));})

	)

50 #iâdeà
sw­


51 
	#sw­
(
a
, 
b
è{‡ =‡ ^ b; b =‡ ^ b;‡ =‡ ^ b; }

	)

54 #iâdeà
¬r_size


55 
	#¬r_size
(
a
èÐ×è/ ×[0]è)

	)

	@proc.c

1 
	~"´oc.h
"

11 
	$cmd_exec
(cÚ¡ *
cmd
, *
pid
)

13 
pid_t
 
p_id
 = -1;

14 
¹
 = -1;

16 ià(
cmd
 =ð
NULL
è
»t
;

18 if((
p_id
 = 
	`fÜk
()è< 0è
»t
;

19 ià(
p_id
 == 0)

21 
	`£g½
();

22 ià(
	`exeþ
("/bš/sh", "sh", "-c", 
cmd
, (*)0))

24 
	`årštf
(
¡d”r
, "exeþ % çžed.", 
cmd
);

25 
»t
;

30 ià(
pid
 !ð
NULL
è*pid = 
p_id
;

32 
	`wa™pid
(
p_id
, &
¹
, 0) < 0)

34 ià(
”ºo
 !ð
EINTR
è
»t
;

37 
¹
 = 0;

40 
»t
:

41  
¹
;

42 
	}
}

53 
	$g‘_sh–l_»tuº
(cÚ¡ *
cmd
, *
»suÉ
, 
size
)

55 
FILE
 *
å
 = 
NULL
;

56 
buf
[128] = {0};

58 ià(
cmd
 =ð
NULL
)  -1;

59 ià((
å
 = 
	`pÝ’
(
cmd
, "r")è=ð
NULL
)  -1;

61 
	`¡rýy
(
»suÉ
, "\0");

62 
	`fg‘s
(
buf
, (buf), 
å
è!ð
NULL
)

64 ià(
»suÉ
 !ð
NULL
 && (
	`¡¾’
ÔesuÉè+ sŒËn(
buf
)è< 
size
)

65 
	`¡rÿt
(
»suÉ
, 
buf
);

68 ià(
å
 !ð
NULL
è
	`pþo£
(fp);

71 
	}
}

82 
	$g‘_sh–l_»suÉ
(cÚ¡ *
cmd
, *
»suÉ
, 
size
)

84 
fd
[2] = {0};

85 
¡©us
 = -1;

86 
n
 = 0;

87 
couÁ
 = 0;

88 
pid_t
 
pid
 = -1;

89 
buf
[256] = {0};

91 ià(
cmd
 =ð
NULL
 || 
»suÉ
 =ðNULL || 
size
 <= 0)  -1;

92 ià(
	`pe
(
fd
) < 0)  -1;

94 
	`¡rýy
(
»suÉ
, "\0");

95 
pid
 = 
	`fÜk
();

96 ià(
pid
 =ð-1è
¡©us
 = -1;

97 ià(
pid
 == 0)

99 
	`þo£
(
fd
[0]);

100 ià(
fd
[1] !ð
STDOUT_FILENO
)

102 ià(
	`dup2
(
fd
[1], 
STDOUT_FILENO
) != STDOUT_FILENO)

103 
	`_ex™
(127);

104 
	`þo£
(
fd
[1]);

106 
	`exeþ
("/bš/sh", "sh", "-c", 
cmd
, (*)0);

107 
	`_ex™
(127);

111 
	`þo£
(
fd
[1]);

112 (
n
 = 
	`»ad
(
fd
[0], 
buf
, (buf))) > 0)

114 
couÁ
 +ð
n
;

115 ià(
couÁ
 < 
size
è
	`¡rÿt
(
»suÉ
, 
buf
);

117 
	`þo£
(
fd
[0]);

119 
	`wa™pid
(
pid
, &
¡©us
, 0) < 0)

121 ià(
”ºo
 !ð
EINTR
)

124 
¡©us
 = 0;

127  
¡©us
;

128 
	}
}

137 
	$g‘_µid
(
pid_t
 
pid
)

139 
·th
[64] = {0};

140 
buf
[128] = {0};

141 
FILE
 *
å
 = 
NULL
;

142 
pid_t
 
µid
 = -1;

144 
	`¥rštf
(
·th
, "/´oc/%d/¡©us", 
pid
);

145 ià((
å
 = 
	`fÝ’
(
·th
, "r")è=ð
NULL
)  -1;

147 
	`fg‘s
(
buf
, (buf), 
å
è!ð
NULL
)

149 ià(
	`¡r¡r
(
buf
, "Pid"è!ð
NULL
)

153 ià(
	`fsÿnf
(
å
, "PPid:%d", &
µid
) == -1)…pid = -1;

154 ià(
å
 !ð
NULL
è
	`fþo£
(fp);

156  
µid
;

157 
	}
}

166 
	$g‘_pid_by_Çme
(cÚ¡ *
´oc_Çme
)

168 
dœ’t
 *
dœ
 = 
NULL
;

169 
DIR
 *
dœp
 = 
NULL
;

170 
pid_t
 
pid
 = -1;

171 
FILE
 *
å
 = 
NULL
;

172 
Çme
[64] = {0};

173 
·th
[128] = {0};

175 ià((
dœp
 = 
	`Ý’dœ
("/´oc/")è=ð
NULL
)  -1;

177 (
dœ
 = 
	`»addœ
(
dœp
)è!ð
NULL
)

179 ià(
dœ
->
d_Çme
 && (
	`©oi
(dir->d_name) > 0))

181 
	`¥rštf
(
·th
, "/´oc/%s/¡©us", 
dœ
->
d_Çme
);

182 ià((
å
 = 
	`fÝ’
(
·th
, "r")è=ð
NULL
) ;

183 ià(
	`fsÿnf
(
å
, "Name:%s", 
Çme
) == -1)

184 
Çme
[0] = '\0';

185 ià(
å
 !ð
NULL
è
	`fþo£
(fp);

186 ià(
	`¡rcmp
(
Çme
, 
´oc_Çme
)) ;

187 
pid
 = 
	`©oi
(
dœ
->
d_Çme
);

192 ià(
dœp
 !ð
NULL
è
	`þo£dœ
(dirp);

194  
pid
;

195 
	}
}

204 
	$g‘_id_by_Çme
(cÚ¡ *
Çme
)

206 
FILE
 *
å
 = 
NULL
;

207 
cmd
[128] = {0};

208 
»t_¡r
[1024] = {0};

209 ià(
Çme
 =ð
NULL
)  -1;

211 
	`¥rštf
(
cmd
, "p -¨| g»°% | \
 -v 'g»p' |‡wk '{…ršˆ$1 }'", 
Çme
);

213 ià((
å
 = 
	`pÝ’
(
cmd
, "r")è=ð
NULL
)  -1;

215 ià(
	`fg‘s
(
»t_¡r
, Ô‘_¡r), 
å
)) ;

216 
	`pþo£
(
å
);

218  
	`©oi
(
»t_¡r
);

219 
	}
}

230 
	$g‘_´oc_Çme_by_pid
(
pid_t
 
pid
, *
´oc_Çme
, 
size
)

232 
·th
[64] = {0};

233 
buf
[128] = {0};

234 *
p
 = 
buf
;

235 
Ën
 = 0;

237 ià(
pid
 < 1)  -1;

238 
	`¥rštf
(
·th
, "/´oc/%d/exe", 
pid
);

239 ià((
Ën
 = 
	`»adlšk
(
·th
, 
buf
, (buf))) < 0)

242 
Ën
 > 0 && 
buf
[len -1] != '/')†en--;

243 
p
 +ð
Ën
;

244 
	`¡ºýy
(
´oc_Çme
, 
p
, 
size
);

247 
	}
}

258 
	$g‘_Çme_by_pid
(
pid_t
 
pid
, *
Çme
, 
size
)

260 
·th
[64] = {0};

261 
buf
[64] = {0};

262 
FILE
 *
å
 = 
NULL
;

263 
¹
 = -1;

265 ià(
Çme
 =ð
NULL
)  -1;

266 
	`¥rštf
(
·th
, "/´oc/%d/¡©us", 
pid
);

267 ià((
å
 = 
	`fÝ’
(
·th
, "r")è=ð
NULL
è
ä“
;

269 ià(
	`fsÿnf
(
å
, "Name: %s", 
buf
è=ð-1è
ä“
;

270 
	`¡ºýy
(
Çme
, 
buf
, 
size
);

271 
¹
 = 0;

273 
ä“
:

274 ià(
å
 !ð
NULL
è
	`fþo£
(fp);

276  
¹
;

277 
	}
}

279 cÚ¡ * 
	$g‘_´oc_Çme
(cÚ¡ *
Çme
)

281 *
Çme
 != '\0' && ( *name == '.' || *name == '/' ))

282 
Çme
++;

284  
Çme
;

285 
	}
}

294 
	$check_´oc_unique
(cÚ¡ *
Çme
)

296 
FILE
 *
å
 = 
NULL
;

297 
cmd
[256] = {0};

298 
buf
[518] = {0};

299 
sk_út
 = 0;

301 
Çme
 = 
	`g‘_´oc_Çme
(name);

302 
	`¥rštf
(
cmd
, "p -¨| g»°% | g»°-v g»°| \
 '{…ršˆ$1}'", 
Çme
);

304 ià((
å
 = 
	`pÝ’
(
cmd
, "r")è=ð
NULL
)  -1;

305 
	`fg‘s
(
buf
, (buf), 
å
è!ð
NULL
)

307 ià(
	`¡¾’
(
buf
è&& 
	`©oi
(buf) > 0)

308 
sk_út
++;

309 ià(
sk_út
 > 1) ;

312 ià(
å
 !ð
NULL
è
	`pþo£
(fp);

313 ià(
sk_út
 > 1)  0;

315 
	}
}

325 
	$is_´oc_unique
(cÚ¡ *
´oc_Çme
)

327 
dœ’t
 *
dœ
 = 
NULL
;

328 
DIR
 *
dœp
 = 
NULL
;

329 
pid_t
 
pid0
 = 
	`g‘_pid_by_Çme
(
´oc_Çme
);

330 
pid_t
 
pid1
 = -1;

331 
FILE
 *
å
 = 
NULL
;

332 
Çme
[64] = {0};

333 
·th
[128] = {0};

335 ià((
dœp
 = 
	`Ý’dœ
("/´oc/")è=ð
NULL
)  -1;

337 (
dœ
 = 
	`»addœ
(
dœp
)è!ð
NULL
)

339 ià(
dœ
->
d_Çme
 && (
	`©oi
(dir->d_name)) > 0)

341 
	`¥rštf
(
·th
, "/´oc/%s/¡©us", 
dœ
->
d_Çme
);

343 ià((
å
 = 
	`fÝ’
(
·th
, "r")è=ð
NULL
) ;

344 ià(
	`fsÿnf
(
å
, "Name:%s", 
Çme
) == -1)

345 
Çme
[0] = '\0';

346 ià(
å
 !ð
NULL
è
	`fþo£
(fp);

348 ià(
	`¡rcmp
(
Çme
, 
´oc_Çme
)) ;

349 
pid1
 = 
	`©oi
(
dœ
->
d_Çme
);

350 ià(
pid0
 !ð
pid1
)

355 ià(
dœp
 !ð
NULL
è
	`þo£dœ
(dirp);

356 ià(
pid0
 !ð
pid1
) …id1;

359 
	}
}

370 
	$g‘_exe_·th_by_pid
(
pid_t
 
pid
, *
·th
, 
size
)

372 
exe_·th
[64] = {0};

373 
buf
[256] = {0};

375 ià(
pid
 <=0 || 
·th
 =ð
NULL
)  -1;

377 
	`¥rštf
(
exe_·th
, "/´oc/%d/exe", 
pid
);

378 ià(
	`»adlšk
(
exe_·th
, 
buf
, (buf)) <= 0)  -1;

379 
	`¡ºýy
(
·th
, 
buf
, 
size
);

382 
	}
}

394 
	$g‘_fže_·th
(
fd
, 
pid
, *
·th
, 
size
)

396 
fd_·th
[128] = {0};

397 
buf
[256] = {0};

399 ià(
fd
 < 0 || 
pid
 <ð0 || 
·th
 =ð
NULL
 || 
size
 <= 0)

402 
	`¥rštf
(
fd_·th
, "/´oc/%d/fd/%d", 
pid
, 
fd
);

403 ià(
	`»adlšk
(
fd_·th
, 
buf
, (buf)) <= 0)  -1;

404 
	`¡ºýy
(
·th
, 
buf
, 
size
);

407 
	}
}

418 
	$g‘_cmdlše
(
pid
, *
cmdlše
, 
size
)

420 
buf
[128] = {0};

421 
¹
 = -1;

423 ià(
cmdlše
 =ð
NULL
 || 
pid
 <=0 ) 
ä“
;

425 
	`¡rýy
(
cmdlše
, "\0");

426 
	`¥rštf
(
buf
, "ÿˆ-v /´oc/%d/cmdlš| sed 's/\\^\\@/\\ /g'", 
pid
);

428 
¹
 = 
	`g‘_sh–l_»suÉ
(
buf
, 
cmdlše
, 
size
);

429 
	`¡rÿt
(
cmdlše
, "\0");

431 
ä“
:

433  
¹
;

434 
	}
}

	@proc.h

1 #iâdeà
__PROC_H__


2 
	#__PROC_H__


	)

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<¡ršg.h
>

7 
	~<uni¡d.h
>

8 
	~<sys/wa™.h
>

9 
	~<sys/ty³s.h
>

10 
	~<dœ’t.h
>

11 
	~<”ºo.h
>

12 
	~<¡d¬g.h
>

13 
	~<fúŽ.h
>

26 
cmd_exec
(cÚ¡ *
cmd
, *
pid
);

37 
g‘_sh–l_»tuº
(cÚ¡ *
cmd
, *
»suÉ
, 
size
);

48 
g‘_sh–l_»suÉ
(cÚ¡ *
cmd
, *
»suÉ
, 
size
);

57 
g‘_µid
(
pid_t
 
pid
);

66 
g‘_pid_by_Çme
(cÚ¡ *
´oc_Çme
);

75 
g‘_id_by_Çme
(cÚ¡ *
Çme
);

86 
g‘_´oc_Çme_by_pid
(
pid_t
 
pid
, *
´oc_Çme
, 
size
);

97 
g‘_Çme_by_pid
(
pid_t
 
pid
, *
Çme
, 
size
);

106 
check_´oc_unique
(cÚ¡ *
Çme
);

116 
is_´oc_unique
(cÚ¡ *
´oc_Çme
);

127 
g‘_exe_·th_by_pid
(
pid_t
 
pid
, *
·th
, 
size
);

139 
g‘_fže_·th
(
fd
, 
pid
, *
·th
, 
size
);

150 
g‘_cmdlše
(
pid
, *
cmdlše
, 
size
);

	@
1
.
0
3
22
macro.h
proc.c
proc.h
